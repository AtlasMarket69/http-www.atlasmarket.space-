<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 15px;
        }

        .sidebar-menu button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .sidebar-menu button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-menu button.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
        }

        .user-info {
            background: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        /* Accounts Section */
        .accounts-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .accounts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .accounts-table thead {
            background: #f8f9fa;
        }

        .accounts-table th,
        .accounts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .accounts-table th {
            font-weight: 600;
            color: #667eea;
        }

        .accounts-table tr:hover {
            background: #f8f9fa;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        /* Products Section */
        .products-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .add-product-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .add-btn {
            grid-column: 1 / -1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .products-table thead {
            background: #f8f9fa;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .products-table th {
            font-weight: 600;
            color: #667eea;
        }

        .products-table tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn:hover {
            background: #2980b9;
        }

        .success-message {
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                margin-left: 200px;
                padding: 15px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .accounts-table,
            .products-table {
                font-size: 12px;
            }

            .accounts-table th,
            .accounts-table td,
            .products-table th,
            .products-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Admin Panel</h2>
            <ul class="sidebar-menu">
                <li><button class="menu-btn active" data-section="dashboard">Dashboard</button></li>
                <li><button class="menu-btn" data-section="accounts">Manage Accounts</button></li>
                <li><button class="menu-btn" data-section="products">Manage Products</button></li>
                <li><button class="menu-btn" data-section="vouches">Manage Vouches</button></li>
                <li><button class="menu-btn" data-section="orders">Invoices / Orders</button></li>
            </ul>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, <strong id="adminUsername">Atlas</strong></span>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h2>Dashboard Overview</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Total Products</h3>
                        <p style="font-size: 28px; font-weight: bold;" id="totalProducts">0</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Total Accounts</h3>
                        <p style="font-size: 28px; font-weight: bold;" id="totalAccounts">0</p>
                    </div>
                </div>
            </div>

            <!-- Accounts Section -->
            <div id="accounts" class="section">
                <h2>Manage Accounts</h2>
                <div class="accounts-container">
                    <div style="margin-bottom: 20px;">
                        <h3>Add New Account</h3>
                        <div class="form-grid" style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="accountUsername">Username</label>
                                <input type="text" id="accountUsername" placeholder="Enter username">
                            </div>
                            <div class="form-group">
                                <label for="accountEmail">Email</label>
                                <input type="email" id="accountEmail" placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label for="accountPassword">Password</label>
                                <input type="password" id="accountPassword" placeholder="Enter password">
                            </div>
                            <div class="form-group">
                                <label for="accountStatus">Status</label>
                                <select id="accountStatus" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <button class="add-btn" id="addAccountBtn" style="grid-column: 1 / -1;">Add Account</button>
                        </div>
                    </div>

                    <div id="accountsSuccessMessage" class="success-message"></div>

                    <h3 style="margin-top: 30px;">Existing Accounts</h3>
                    <div id="accountsTableContainer">
                        <div class="no-data">No accounts found. Add one above.</div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="section">
                <h2>Manage Products</h2>
                <div class="products-container">
                    <div class="add-product-form">
                        <h3>Add New Product</h3>
                        <div class="form-grid" style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" placeholder="e.g., Fortnite | Ultimate">
                            </div>
                            <div class="form-group">
                                <label for="productPrice">Price ($)</label>
                                <input type="number" id="productPrice" placeholder="e.g., 3.99" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="productQuantity">Stock Quantity</label>
                                <input type="number" id="productQuantity" placeholder="e.g., 10" step="1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="productStock">Stock Status</label>
                                <select id="productStock" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                    <option value="in-stock">In Stock</option>
                                    <option value="low-stock">Low Stock</option>
                                    <option value="out-of-stock">Out of Stock</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productBanner">Banner Image File</label>
                                <input type="text" id="productBanner" placeholder="e.g., bannerr/FORNITE-ULTIMATE.jpg">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" placeholder="Enter product description"></textarea>
                            </div>
                            <button class="add-btn" id="addProductBtn">Add Product</button>
                        </div>
                    </div>

                    <div id="productsSuccessMessage" class="success-message"></div>

                    <h3>Existing Products</h3>
                    <div id="productsTableContainer">
                        <div class="no-data">No products found. Add one above.</div>
                    </div>
                </div>
            </div>

            <!-- Vouches Section -->
            <div id="vouches" class="section">
                <h2>Manage Vouches</h2>
                <div class="products-container">
                    <h3>All Vouches</h3>
                    <div id="vouchesTableContainer">
                        <div class="no-data">No vouches found.</div>
                    </div>
                </div>
            </div>

            <!-- Announcements Section -->
            <div id="announcements" class="section">
                <h2>Announcements</h2>
                <div class="products-container">
                    <div class="add-product-form">
                        <h3>Create Announcement</h3>
                        <div class="form-grid" style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="announcementTitle">Title</label>
                                <input type="text" id="announcementTitle" placeholder="Short title (optional)">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="announcementMessage">Message</label>
                                <textarea id="announcementMessage" placeholder="Announcement message"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="announcementActive">Active</label>
                                <select id="announcementActive" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <button class="add-btn" id="addAnnouncementBtn">Create Announcement</button>
                        </div>
                    </div>

                    <h3>Existing Announcements</h3>
                    <div id="announcementsList">
                        <div class="no-data">No announcements yet.</div>
                    </div>
                </div>
            </div>

            <!-- Orders / Invoices Section -->
            <div id="orders" class="section">
                <h2>Invoices / Orders</h2>
                <div class="products-container">
                    <h3>Recent Orders</h3>
                    <div id="ordersTableContainer">
                        <div class="no-data">No orders yet.</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Check if user is logged in
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.replace('admin-login.html');
        }

        // Display username
        document.getElementById('adminUsername').textContent = localStorage.getItem('adminUsername') || 'Admin';

        // Initialize data from localStorage
        let accounts = JSON.parse(localStorage.getItem('adminAccounts')) || [];
        let products = [];
        const ADMIN_SECRET = 'atlas-secret'; // change to match server ADMIN_SECRET if set

        // Load products from server
        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                if (res.ok) {
                    products = await res.json();
                } else {
                    products = [];
                }
            } catch (e) {
                console.error('Failed to load products:', e);
                products = [];
            }
            renderProducts();
            updateDashboard();
        }

        // Load announcements (used by dashboard when needed)
        async function loadAnnouncements() {
            try {
                const res = await fetch('/api/announcements');
                if (res.ok) {
                    const anns = await res.json();
                    renderAnnouncements(anns);
                }
            } catch (e) {
                console.error('Failed to load announcements:', e);
            }
        }

        // Load vouches from server
        let vouches = [];
        async function loadVouches() {
            try {
                const res = await fetch('/api/vouches');
                if (res.ok) {
                    vouches = await res.json();
                } else {
                    vouches = [];
                }
            } catch (e) {
                console.error('Failed to load vouches:', e);
                vouches = [];
            }
            renderVouches();
        }

        // Render vouches table
        function renderVouches() {
            const container = document.getElementById('vouchesTableContainer');
            if (vouches.length === 0) {
                container.innerHTML = '<div class="no-data">No vouches found.</div>';
                return;
            }
            let html = '<table class="products-table"><thead><tr><th>User</th><th>Product</th><th>Rating</th><th>Comment</th><th>Created</th><th>Action</th></tr></thead><tbody>';
            vouches.forEach(v => {
                html += `<tr><td>${v.username}</td><td>${v.product}</td><td>${'â˜…'.repeat(v.rating)}</td><td>${v.comment.substring(0, 50)}...</td><td>${new Date(v.created_at).toLocaleDateString()}</td><td><button class="delete-btn" onclick="deleteVouch(${v.id})">Delete</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete vouch (admin)
        async function deleteVouch(id) {
            if (!confirm('Delete this vouch?')) return;
            try {
                const res = await fetch(`/api/admin/vouches/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-admin-secret': ADMIN_SECRET }
                });
                if (!res.ok) {
                    alert((await res.json()).error || 'Failed to delete');
                    return;
                }
                await loadVouches();
            } catch (err) {
                console.error('Delete vouch error:', err);
                alert('Failed to delete vouch');
            }
        }

        // Render announcements
        function renderAnnouncements(anns) {
            const container = document.getElementById('announcementsList');
            if (anns.length === 0) {
                container.innerHTML = '<div class="no-data">No announcements yet.</div>';
                return;
            }
            let html = '<table class="products-table"><thead><tr><th>Title</th><th>Message</th><th>Status</th><th>Created</th><th>Action</th></tr></thead><tbody>';
            anns.forEach(a => {
                html += `<tr><td>${a.title || '(no title)'}</td><td>${a.message.substring(0, 50)}...</td><td>${a.active ? 'Active' : 'Inactive'}</td><td>${new Date(a.created_at).toLocaleDateString()}</td><td><button class="delete-btn" onclick="deleteAnnouncement(${a.id})">Delete</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete announcement
        async function deleteAnnouncement(id) {
            if (!confirm('Delete this announcement?')) return;
            try {
                const res = await fetch(`/api/announcements/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-admin-secret': ADMIN_SECRET }
                });
                if (!res.ok) {
                    alert((await res.json()).error || 'Failed to delete');
                    return;
                }
                await loadAnnouncements();
            } catch (err) {
                console.error('Delete announcement error:', err);
                alert('Failed to delete announcement');
            }
        }

        // Add announcement
        document.getElementById('addAnnouncementBtn') && document.getElementById('addAnnouncementBtn').addEventListener('click', async function() {
            const title = document.getElementById('announcementTitle').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const active = document.getElementById('announcementActive').value === 'true';

            if (!message) {
                alert('Message is required');
                return;
            }

            try {
                const res = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-secret': ADMIN_SECRET
                    },
                    body: JSON.stringify({ title: title || null, message, active })
                });

                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Failed to create announcement');
                    return;
                }

                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementMessage').value = '';
                document.getElementById('announcementActive').value = 'true';

                alert('Announcement created!');
                await loadAnnouncements();
            } catch (err) {
                console.error('Add announcement error:', err);
                alert('Failed to create announcement');
            }
        });

        // Sidebar menu functionality
        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                
                // Remove active class from all buttons and sections
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked button and corresponding section
                this.classList.add('active');
                document.getElementById(section).classList.add('active');

                // Refresh data when switching sections
                if (section === 'accounts') {
                    renderAccounts();
                } else if (section === 'products') {
                    loadProducts();
                } else if (section === 'vouches') {
                    loadVouches();
                } else if (section === 'orders') {
                    loadOrders();
                } else if (section === 'announcements') {
                    loadAnnouncements();
                } else if (section === 'dashboard') {
                    updateDashboard();
                }
            });
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUsername');
            window.location.href = 'admin-login.html';
        });

        // Add Account
        document.getElementById('addAccountBtn').addEventListener('click', function() {
            const username = document.getElementById('accountUsername').value.trim();
            const email = document.getElementById('accountEmail').value.trim();
            const password = document.getElementById('accountPassword').value.trim();
            const status = document.getElementById('accountStatus').value;

            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            const newAccount = {
                id: Date.now(),
                username,
                email,
                password,
                status,
                createdAt: new Date().toLocaleDateString()
            };

            accounts.push(newAccount);
            localStorage.setItem('adminAccounts', JSON.stringify(accounts));

            // Clear form
            document.getElementById('accountUsername').value = '';
            document.getElementById('accountEmail').value = '';
            document.getElementById('accountPassword').value = '';
            document.getElementById('accountStatus').value = 'active';

            // Show success message
            const successMsg = document.getElementById('accountsSuccessMessage');
            successMsg.textContent = 'Account added successfully!';
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);

            renderAccounts();
            updateDashboard();
        });

        // Add Product (server-backed)
        document.getElementById('addProductBtn').addEventListener('click', async function() {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value;
            const quantity = document.getElementById('productQuantity') ? document.getElementById('productQuantity').value : null;
            const stock = document.getElementById('productStock').value;
            const banner = document.getElementById('productBanner').value.trim();
            const description = document.getElementById('productDescription').value.trim();

            if (!name || !price || !banner || !description) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const body = { name, price: parseFloat(price), banner, description };
                if (quantity !== null) body.stock_quantity = parseInt(quantity, 10);
                // allow admin to override stock status, otherwise server will derive from quantity
                body.stock_status = stock;

                const res = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-secret': ADMIN_SECRET
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Failed to create product');
                    return;
                }

                // Clear form
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                if (document.getElementById('productQuantity')) document.getElementById('productQuantity').value = '0';
                document.getElementById('productStock').value = 'in-stock';
                document.getElementById('productBanner').value = '';
                document.getElementById('productDescription').value = '';

                // Show success message
                const successMsg = document.getElementById('productsSuccessMessage');
                successMsg.textContent = 'Product added successfully!';
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 3000);

                await loadProducts();
            } catch (err) {
                console.error('Add product error:', err);
                alert('Failed to add product');
            }
        });

        // Render accounts table
        function renderAccounts() {
            const container = document.getElementById('accountsTableContainer');
            
            if (accounts.length === 0) {
                container.innerHTML = '<div class="no-data">No accounts found. Add one above.</div>';
                return;
            }

            let html = `
                <table class="accounts-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            accounts.forEach(account => {
                html += `
                    <tr>
                        <td>${account.username}</td>
                        <td>${account.email}</td>
                        <td><span style="background: ${account.status === 'active' ? '#2ecc71' : '#e74c3c'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${account.status}</span></td>
                        <td>${account.createdAt}</td>
                        <td><button class="delete-btn" onclick="deleteAccount(${account.id})">Delete</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Render products table
        function renderProducts() {
            const container = document.getElementById('productsTableContainer');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="no-data">No products found. Add one above.</div>';
                return;
            }

            let html = `
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach(product => {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>$${Number(product.price).toFixed(2)}</td>
                        <td><span style="background: ${(typeof product.stock_quantity !== 'undefined' && product.stock_quantity !== null) ? (product.stock_quantity > 5 ? '#2ecc71' : product.stock_quantity > 0 ? '#f39c12' : '#e74c3c') : (product.stock_status === 'in-stock' ? '#2ecc71' : product.stock_status === 'low-stock' ? '#f39c12' : '#e74c3c')}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${(typeof product.stock_quantity !== 'undefined' && product.stock_quantity !== null) ? (product.stock_quantity > 5 ? 'In Stock' : product.stock_quantity > 0 ? 'Low Stock' : 'Out of Stock') : (product.stock_status || 'Unknown')} ${typeof product.stock_quantity !== 'undefined' && product.stock_quantity !== null ? '(' + product.stock_quantity + ')' : ''}</span></td>
                        <td>${new Date(product.created_at).toLocaleDateString()}</td>
                        <td><button class="delete-btn" onclick="deleteProduct(${product.id})">Delete</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete account
        function deleteAccount(id) {
            if (confirm('Are you sure you want to delete this account?')) {
                accounts = accounts.filter(a => a.id !== id);
                localStorage.setItem('adminAccounts', JSON.stringify(accounts));
                renderAccounts();
                updateDashboard();
            }
        }

        // Delete product (server)
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            try {
                const res = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-admin-secret': ADMIN_SECRET }
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Failed to delete product');
                    return;
                }
                await loadProducts();
            } catch (err) {
                console.error('Delete product error:', err);
                alert('Failed to delete product');
            }
        }

        // Update dashboard stats
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalAccounts').textContent = accounts.length;
        }

        // Initial load
        loadProducts();
        loadVouches();
        // orders loaded on demand
        loadAnnouncements();
        updateDashboard();

        // Orders
        async function loadOrders() {
            try {
                const res = await fetch('/api/orders', { headers: { 'x-admin-secret': ADMIN_SECRET } });
                if (!res.ok) throw new Error('Failed to fetch orders');
                const orders = await res.json();
                renderOrders(orders);
            } catch (err) {
                console.error('Failed to load orders:', err);
                document.getElementById('ordersTableContainer').innerHTML = '<div class="no-data">Failed to load orders.</div>';
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('ordersTableContainer');
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="no-data">No orders found.</div>';
                return;
            }
            let html = '<table class="products-table"><thead><tr><th>Order ID</th><th>Product</th><th>Amount</th><th>Currency</th><th>Status</th><th>Created</th><th>Action</th></tr></thead><tbody>';
            orders.forEach(o => {
                const created = new Date(o.created_at).toLocaleString();
                let action = '';
                if (o.payment_url) action += `<a href="${o.payment_url}" target="_blank">Pay</a> `;
                if (o.delivery_data) {
                    try {
                        const d = typeof o.delivery_data === 'string' ? JSON.parse(o.delivery_data) : o.delivery_data;
                        if (d.type === 'download' && d.token) action += ` <a href="/download/${d.token}" target="_blank">Download</a>`;
                        if (d.type === 'license' && d.key) action += ` <span>Key: ${d.key}</span>`;
                    } catch(e){}
                }
                html += `<tr><td>${o.order_id}</td><td>${o.product_name}</td><td>$${Number(o.amount).toFixed(2)}</td><td>${o.currency}</td><td>${o.status}</td><td>${created}</td><td>${action}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>
